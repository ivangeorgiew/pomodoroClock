(function(s){var w,f={},o=window,l=console,m=Math,z='postMessage',x='HackTimer.js by turuslan: ',v='Initialisation failed',p=0,r='hasOwnProperty',y=[].slice,b=o.Worker;function d(){do{p=0x7FFFFFFF>p?p+1:0}while(f[r](p));return p}if(!/MSIE 10/i.test(navigator.userAgent)){try{s=o.URL.createObjectURL(new Blob(["var f={},p=postMessage,r='hasOwnProperty';onmessage=function(e){var d=e.data,i=d.i,t=d[r]('t')?d.t:0;switch(d.n){case'a':f[i]=setInterval(function(){p(i)},t);break;case'b':if(f[r](i)){clearInterval(f[i]);delete f[i]}break;case'c':f[i]=setTimeout(function(){p(i);if(f[r](i))delete f[i]},t);break;case'd':if(f[r](i)){clearTimeout(f[i]);delete f[i]}break}}"]))}catch(e){}}if(typeof(b)!=='undefined'){try{w=new b(s);o.setInterval=function(c,t){var i=d();f[i]={c:c,p:y.call(arguments,2)};w[z]({n:'a',i:i,t:t});return i};o.clearInterval=function(i){if(f[r](i))delete f[i],w[z]({n:'b',i:i})};o.setTimeout=function(c,t){var i=d();f[i]={c:c,p:y.call(arguments,2),t:!0};w[z]({n:'c',i:i,t:t});return i};o.clearTimeout=function(i){if(f[r](i))delete f[i],w[z]({n:'d',i:i})};w.onmessage=function(e){var i=e.data,c,n;if(f[r](i)){n=f[i];c=n.c;if(n[r]('t'))delete f[i]}if(typeof(c)=='string')try{c=new Function(c)}catch(k){l.log(x+'Error parsing callback code string: ',k)}if(typeof(c)=='function')c.apply(o,n.p)};w.onerror=function(e){l.log(e)};l.log(x+'Initialisation succeeded')}catch(e){l.log(x+v);l.error(e)}}else l.log(x+v+' - HTML5 Web Worker is not supported')})('HackTimerWorker.min.js');
/* CONSTANTS */
const sMin = document.querySelector('.s--min');
const sPlus = document.querySelector('.s--plus');
const sSes = document.querySelector('.span--session');
const bReset = document.querySelector('.b--reset');
const pTimer = document.querySelector('.p--timer');
const bTimer = document.querySelector('.b--timer');
const beep = new Audio('assets/beep.mp3');
let myNoti




/* Allow Notification */
if(Notification.permission !== 'granted') {
  Notification.requestPermission().then(perm => {
    if(perm === 'granted')
      console.log('Notifications will show');
  });
}




/* FUNCTION FOR SETTINGS */
const minOrPlus = (op, n)=>{
  if(op === 'min' && n.innerHTML > 0){
    n.innerHTML -= 5; 
  }
  else if(op == 'plus' && n.innerHTML < 100){
    n.innerHTML = +n.innerHTML + 5; 
  }

  pTimer.innerHTML = sSes.innerHTML + ':00';
};




/* FUNCTIONS FOR COUNTING */
const setSecs = (mins, secs)=>{
  if(secs > 10)
    return mins + ':' + (secs-1);
  else if(secs > 0)
    return mins + ':0' + (secs-1);
  else
    return setMins(mins);
};

const setMins = (mins)=>{
  if(mins > 10)
    return (mins-1) + ':59';
  else if(mins > 0)
    return (mins-1) + ':59';
  else
    return '00:00';
};




/* FUNCTIONS FOR TIMER */
const stop = (intervalID) => {
  clearInterval(intervalID);

  sMin.disabled = sPlus.disabled = false;
  bTimer.style.background = 'none';

  bTimer.onclick = () => {run();};
};

const change = () => {
  beep.play();

  //add notification
  if(!myNoti) {
    myNoti= new Notification('Timer Ended', { requireInteraction: false });
    myNoti.onclick = function() {
      setTimeout(myNoti.close.bind(myNoti), 500);
      myNoti = undefined

      pTimer.innerHTML = sSes.innerHTML + ':00';
    }
  }

  bTimer.onclick = () => {
    //remove notification
    if(myNoti) {
      setTimeout(myNoti.close.bind(myNoti), 500);
      myNoti = undefined;
    }

    pTimer.innerHTML = sSes.innerHTML + ':00';
  };
};

const run = () => {
  //Stop from clicking too fast
  if(bTimer.style.background === 'yellow')
    return;

  sMin.disabled = sPlus.disabled = true;
  bTimer.style.background = 'yellow';

  const intervalID = setInterval(() => {
    //Running and Stopping
    if(pTimer.innerHTML !== '00:00'){
      pTimer.innerHTML = 
        setSecs(pTimer.innerHTML.split(':')[0],
                pTimer.innerHTML.split(':')[1]);

      bTimer.onclick = () => { stop(intervalID); };
    }

    //Changing between Session and Break
    else change();
  }, 1000);

  //Reset button
  bReset.onclick = () => {
    stop(intervalID);
    pTimer.innerHTML = sSes.innerHTML + ':00';

    //remove notification
    if(myNoti) {
      setTimeout(myNoti.close.bind(myNoti), 500);
      myNoti = undefined;
    }
  };
};





/* VOLUME */
beep.volume = 1;




/* SETTINGS */
sMin.onclick = () => { minOrPlus('min', sSes); };
sPlus.onclick = () => { minOrPlus('plus', sSes); };




/* TIMER */
bTimer.onclick = () => { run(); };

window.addEventListener('DOMContentLoaded', () => { bTimer.click() }, false)
